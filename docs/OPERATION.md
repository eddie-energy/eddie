# EDDIE Framework operation manual

## Quickstart

A quickstart configuration to run the EDDIE Framework is provided in the `env` folder of the development project. The
steps to make it run are:

1. Download the quickstart configuration folder from [EDDIE /env](https://github.com/eddie-energy/eddie/tree/main/env)
2. Run `docker compose up -d` in that folder.
3. Open browser on http://127.0.0.1:9000/prototype/main/ and experiment with the provided sample application.
4. As many permission administrators and metered data administrators require additional installation or registration
   steps, it's best to try out the framework functionality using the permission administrator called _simulation_.

## Installation

TBD.

A sample container configuration in `docker-compose.yml`:

```yaml
version: "3.9"
services:
  eddie:
    image: ghcr.io/eddie-energy/eddie:latest
    environment:
      JDBC_URL: "jdbc:postgresql://localhost:5432/example_app"
      JDBC_USER: "test"
      JDBC_PASSWORD: "test"
      PUBLIC_CONTEXT_PATH: "" # default value
      EDDIE_DATA_NEEDS_CONFIG_FILE: "./config/data-needs.json" # default value
    volumes:
      - ./ponton:/ponton
      - ./data-needs.json:/opt/eddie/config/data-needs.json
```

| Variable                       | Description                             |
|--------------------------------|-----------------------------------------|
| `EDDIE_DATA_NEEDS_CONFIG_FILE` | File containing data needs definitions. |

As the configuration of region connectors is quite complex and there are many properties, the environment is
configured in the accompanying `.env` file (see [EDDIE /env](https://github.com/eddie-energy/eddie/tree/main/env)
directory for a reference).
The example `.env` file contains all configuration options.

## Update

TBD.

# Using the EDDIE Button in an application

To use the _EDDIE Button_ in an eligible party application, the EP application has to include the button in its HTML
page. It can be integrated into a frontend based application (e.g. a single-page application) or into a server rendered
web application as it's implemented using standard HTML custom elements.

```html

<script type="module" src="${eddieUrl}/lib/eddie-components.js"></script>
<!-- ... -->
<eddie-connect-button
  connection-id="1"
  data-need-id="9bd0668f-cc19-40a8-99db-dc2cb2802b17"
></eddie-connect-button>
```

`${eddieUrl}` is to be replaced with the public base URL of your EDDIE instance.

The `eddie-connect-button` element can be configured using the following attributes:

| Attribute                           | Type    | Description                                                                                                          | Required |
|-------------------------------------|---------|----------------------------------------------------------------------------------------------------------------------|----------|
| `connection-id`                     | String  | The connection id is generated by the EP application _integrating_ EDDIE and is used to identify generated requests. | Yes      |
| `data-need-id`                      | String  | ID of a pre-configured data need.                                                                                    | Yes      |
| `permission-administrator`          | String  | Sets a fixed permission administrator to use by its id.                                                              | No       |
| `accounting-point-id`               | String  | Sets a fixed accounting point id for permission administrators supporting this feature.                              | No       |
| `remember-permission-administrator` | Boolean | If true, the most recent permission administrator is stored and loaded from local storage.                           | No       |

The `connectionId` has to be generated by the EP application. It's included in the messages sent by EDDIE
so that button instance can match with the data stream that is created using it. The EP application is also
responsible for storing previous connection IDs and linking them to the users of the EP application. Each connection id must be used only once to create a uniquely identifiable connection with EDDIE.

## Interaction and request status events

The EDDIE button fires events to inform the EP application about the status of the user interaction, and the status of the permission request. These events can be listened to by the EP application to update the UI or to trigger further actions.

Permission request states are described in [PERMISSION_STATES.md](PERMISSION_STATES.md). To match the naming of event and attribute names common in HTML and JavaScript, the status names are converted to lowercase and hyphens are used as separators. Event handler attributes also have the hyphens removed. For example, the status `UNABLE_TO_SEND` is converted to `unable-to-send` for events and `onunabletosend` for the event handler attribute.

> [!IMPORTANT]
> Please note that status events on the client side are not a reliable source of information about the status of the permission request!

### Events

Permission state events work as standard HTML events and can be listened to using the `addEventListener` method.

```js
const button = document.querySelector("eddie-connect-button");
button.addEventListener("eddie-dialog-open", () => {
  console.log("Dialog opened");
});
```

| Event                    | Description                                                                                                                              |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------|
| `eddie-dialog-open`      | Dispatched when the dialog is opened.                                                                                                    |
| `eddie-dialog-close`     | Dispatched when the dialog is closed.                                                                                                    |
| `eddie-request-status`   | Dispatched when the status of the permission request changes. The event detail contains the new status.                                  |
| `eddie-request-created`  | Dispatched when the permission request has been created. The event detail contains an endpoint to query the current status from.         |
| `eddie-request-{status}` | In addition to `eddie-request-status`, an event with the name of the request status is dispatched. For example, `eddie-request-created`. |

### Callback functions

The button can also be passed callback functions to react to user interaction and status change events.
The callback function has to be defined in the global scope and is passed as a string attribute to the button.

| Attribute        | Called when ...                                                                                                                                   |
|------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| `onopen`         | The dialog is opened (the button is pressed).                                                                                                     |
| `onclose`        | The dialog is closed.                                                                                                                             |
| `onstatuschange` | The status of the permission request has changed. `event.detail.status` contains the new status.                                                  |
| `oncreated`      | The permission request has been created. `event.detail.location` contains an endpoint to query the current status from.                           |
| `on{status}`     | The status of the permission request has changed to `{status}`. Where `{status}` is in lowercase letters. For example, `onaccepted`, `onrejected` |

> [!TIP]
> The name of the attribute is case-insensitive, so they can be cased for better readability.

```html

<eddie-connect-button
  ...
  onopen="console.log('Dialog opened')"
  onclose="console.log('Dialog closed')"
  onstatuschange="handleStatusChange(event)"
  oncreated="console.log('Permission request created')"
  onaccepted="console.log('Permission request accepted')"
  onrejected="console.log('Permission request rejected')"
></eddie-connect-button>
```

## Controlling the EDDIE button programmatically

The EDDIE button exposes methods to control its behavior programmatically.

- `openDialog()`: Opens the dialog. Similar to clicking the button.
- `closeDialog()`: Closes the dialog, keeping the button in its current state.
- `reset()`: Resets the button to its initial state. Does not close the dialog if it is already open.

```js
const button = document.querySelector("eddie-connect-button");
button.openDialog();
button.reset();
button.closeDialog();
```

Please use with care! Closing or resetting the button programmatically can lead to unexpected behavior or break the user experience if the user is still interacting with the button. Similarly, opening the dialog programmatically can be seen as intrusive and should be used with caution.

# Configuration

It is recommended to configure EDDIE core and the region connectors via the `.env` file in combination with
the `docker-compose.yml` file.

## Configuring EDDIE Core

EDDIE Core can be configured by the following environment variables.
You can also modify the [application.properties](../core/src/main/resources/application.properties) file directly, but
the recommendation is to use the `.env` which accompanies the [docker-compose.yml](../env/docker-compose.yml) file.

| Parameter                                                            | Description                                                                                                                                                                                                                                                                                                    |
|----------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| CORE_PORT                                                            | Port on which the server should listen. 8080 by default.                                                                                                                                                                                                                                                       |
| JDBC_URL                                                             | JDB URL to PostgreSQL database where EDDIE will store permission requests and data needs.                                                                                                                                                                                                                      |
| JDBC_USER                                                            | Username to authenticate with the PostgreSQL server.                                                                                                                                                                                                                                                           |
| JDBC_PASSWORD                                                        | Password to authenticate with the PostgreSQL server.                                                                                                                                                                                                                                                           |
| EDDIE_CORS_ALLOWED_ORIGINS                                           | Pattern for allowed CORS origins. See [SpringDoc](<https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/config/annotation/CorsRegistration.html#allowedOriginPatterns(java.lang.String...)>) for more details. If not specified, no CORS requests will be allowed. |
| EDDIE_JWT_HMAC_SECRET                                                | Secret used to sign JWTs issued by EDDIE. Supply 32 random (!) bytes encoded as Base64 string.                                                                                                                                                                                                                 |
| EDDIE_PUBLIC_URL                                                     | Public URL where external clients can reach EDDIE core.                                                                                                                                                                                                                                                        |
| KAFKA_ENABLED                                                        | Set to `true` to enable publishing of status & data messages to the specified Kafka cluster.                                                                                                                                                                                                                   |
| KAFKA_BOOTSTRAP_SERVERS                                              | Comma separated list of Kafka server IPs/hostnames.                                                                                                                                                                                                                                                            |
| EDDIE_RAW_DATA_OUTPUT_ENABLED                                        | If set to `true`, supporting region connectors will publish the raw message as they receive it from the MDA to a dedicated Kafka topic.                                                                                                                                                                        |
| EDDIE_PERMISSION_REQUEST_TIMEOUT_DURATION                            | Sets the duration after which a permission request, which was neither accepted nor rejected, is considered stale. Default is 168 hours (7 days).                                                                                                                                                               |
| EDDIE_PERMISSION_REQUEST_TIMEOUT_SCHEDULE                            | Sets the schedule when stale permission requests should be timed out. Uses Spring Cron syntax. Default is hourly.                                                                                                                                                                                              |
| EDDIE_MANAGEMENT_SERVER_PORT                                         | Port for the management api (only available if _EDDIE_DATA_NEEDS_CONFIG_DATA_NEED_SOURCE=DATABASE_).                                                                                                                                                                                                           |
| EDDIE_MANAGEMENT_SERVER_URLPREFIX                                    | Url prefix for the management api (must not be used for other purposes).                                                                                                                                                                                                                                       |
| EDDIE_DATA_NEEDS_CONFIG_DATA_NEED_SOURCE                             | Source where to read data needs from. Either `config` or `database`.                                                                                                                                                                                                                                           |
| EDDIE_DATA_NEEDS_CONFIG_FILE                                         | File containing data needs definitions.                                                                                                                                                                                                                                                                        |
| EDDIE_CONVERTERS_POWER                                               | When set to `true` enables the converter to convert energy to power measurements.                                                                                                                                                                                                                              |
| EDDIE_CONVERTERS_ENERGY                                              | When set to `true` enables the converter to convert power to energy measurements.                                                                                                                                                                                                                              |
| REGION*CONNECTOR*<country-code>\_<permission-administrator>\_ENABLED | `true` to enable the specific region connector. By default, only region connectors requiring no explicit configuration are enabled. Ensure that you set any other required configuration for the region connector as otherwise EDDIE may fail to start.                                                        |

### Configuring region connectors

To retrieve data from various regions and countries, it is crucial to correctly set up the relevant region connectors.

For each region connector, specific configurations and prerequisites are necessary for operation.
Details for these setups are provided in the README file of the individual region connector. You can locate these files
under `region-connectors/region-connector-<country-code>-<permission-administrator>/README.md`.

Or you can use the following links:

- [Austria (EDA)](./../region-connectors/region-connector-at-eda/README.md)
- [Denmark (Energinet)](./../region-connectors/region-connector-dk-energinet/README.md)
- [France (Enedis)](./../region-connectors/region-connector-fr-enedis/README.md)
- [Spain (Datadis)](./../region-connectors/region-connector-es-datadis/README.md)
- [AIIDA (Near real-time data)](./../region-connectors/region-connector-aiida/README.md)
- [Netherlands (Mijn Aansluiting)](./../region-connectors/region-connector-nl-mijn-aansluiting/README.md)

### Business domain related configuration

#### Common Information Model (CIM)

For the mapping of region specific data to the common information model (CIM) the following configuration parameters
need to be set:

| Parameter                                 | Type                               | Description                                                                                         |
|-------------------------------------------|------------------------------------|-----------------------------------------------------------------------------------------------------|
| cim.eligible-party.national-coding-scheme | A valid CodingSchemeTypeList value | Most of the time just 'N' + your country code e.g NAT if you are located in Austria                 |
| cim.eligible-party.fallback.id            | String                             | Fallback ID for the eligible party in case the region does not provide an ID for the eligible party |

E.g. eligible party in Austria:

```
cim.eligible-party.national-coding-scheme=NAT
cim.eligible-party.fallback.id=EDDIE-Online
```

#### Data need configuration

A data need describes a configuration for the _Connect Button_. By using that button, the type of data and time frame is
predefined so that the EP application receives data that it actually needs to perform its job.

Data needs can be configured in two ways: via a JSON file that is read on startup, they can be created via a REST-ful
API which stores the data needs in the core's database.

| Parameter                                | Type              | Description                                            |
|------------------------------------------|-------------------|--------------------------------------------------------|
| eddie.data-needs-config.data-need-source | CONFIG / DATABASE | Specifies the location where data needs are read from. |

If this is set to `CONFIG`, the property `EDDIE_DATA_NEEDS_CONFIG_FILE` needs to be set, otherwise the file is ignored.
It is not possible to combine `CONFIG` and `DATABASE` modes.

#### Data needs in config mode

See the file [env/data-needs.json](env/data-needs.json) for a full example configuration.
While the REST-API ignores the ID field for creation requests, when supplying data needs via the JSON file,
the ID is a mandatory field.

```json
{
  "type": "validated",
  "id": "9bd0668f-cc19-40a8-99db-dc2cb2802b17",
  "name": "LAST_3_MONTHS_ONE_MEASUREMENT_PER_DAY",
  "description": "Historical validated consumption data for the last three months, one measurement per day",
  "purpose": "Some purpose",
  "policyLink": "https://example.com/toc",
  "duration": {
    "type": "relativeDuration",
    "start": "-P3M",
    "end": "P0D"
  },
  "energyType": "ELECTRICITY",
  "minGranularity": "P1D",
  "maxGranularity": "P1D",
  "enabled": true,
  "regionConnectorFilter": {
    "type": "blocklist",
    "regionConnectorIds": [
      "es-datadis"
    ]
  }
}
```

All data needs have these common fields:

| Attribute             | Type    | Description                                                                                                                                                                                                                                         |
|-----------------------|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| type                  | String  | Type of the data need, e.g. `validated` for historical validated consumption data. Please check the OpenAPI documentation for all supported values.                                                                                                 |
| id                    | String  | Unique id that can be used to reference this data need.                                                                                                                                                                                             |
| name                  | String  | Short memorable name of the data need that may be presented to the customer.                                                                                                                                                                        |
| description           | String  | Multiline string that describes this data need in a human readable form to be shown in the UI.                                                                                                                                                      |
| purpose               | String  | Multiline string that describes the purpose of this data need.                                                                                                                                                                                      |
| policyLink            | URL     | URL to the data policy that applies to this data need.                                                                                                                                                                                              |
| enabled               | boolean | Enables or disables a data need.                                                                                                                                                                                                                    |
| regionConnectorFilter | Object  | _Optional_ If set describes either which region connectors are allowed to process the data need (type: `allowlist`) or which region connectors are blocked from processing the data need (type: `blocklist`). Completely omit it for no restriction |

Depending on the `type`, a data need may require more fields, e.g. for validated historical consumption data:

| Attribute      | Type   | Description                                                                                                                                                                                                                                                                                                                                |
|----------------|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| duration       | Object | Describes the timeframe for this data need.                                                                                                                                                                                                                                                                                                |
| energyType     | String | Type of energy to be requested. See OpenAPI documentation for all possible values.                                                                                                                                                                                                                                                         |
| minGranularity | String | Desired granularity of the data that should be requested.                                                                                                                                                                                                                                                                                  |
| maxGranularity | String | Maximum accepted granularity. Not all MDAs supply the data in the same granularity, if your application can handle multiple granularities, set this to a higher value than `minGranularity` and the region connectors will automatically retry to fetch the data in a higher granularity if the data is not available in `minGranularity`. |

A data need is mandatory for each _Connect with EDDIE_ Button.

Please see the OpenAPI documentation (default: http://localhost:8080/data-needs/swagger-ui/index.html) for further
details about all possible data need types and their respective fields.
Please note that while the REST-ful API allows that data needs are deleted, it might not be a good idea to delete a data
need in production. This is because permission requests reference the data need and deleting the data need may render
the data needs useless.

### External system related

#### Kafka Connector

All configuration values that are available for Kafka producers and consumers are supported,
see [kafka: Producer Configs](https://kafka.apache.org/28/documentation.html#producerconfigs). To include them the
prefix `kafka.` has to be used.

The following parameters are of special interest:

| Parameter               | Type                                           | Description                                                                                                       |
|-------------------------|------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| kafka.bootstrap.servers | comma-separated _host:port_ tuples (mandatory) | A list of host/port pairs to use for establishing the initial connection to the Kafka cluster.                    |
| kafka.enable            | true/false                                     | Enables or disables the kafka connector.                                                                          |
| kafka.termination.topic | valid kafka topic name                         | The topic on which the kafka connector listens for termination requests. Optional, the default is `terminations`. |

E.g. if Kafka is installed locally:

```
kafka.bootstrap.servers=localhost:9094
```

##### Termination of Permission Requests

To terminate permission requests, a consent market document in json format has to be sent to
the `kafka.termination.topic`.
The key should be the ID of the region connector, from which the request originated.
The consent market document for termination can look like the following JSON message.
**Keep in mind that some kafka clients use newlines as message separator, in that case minimize the message, or change
the message separator!**

```json
{
  "mrid": "REPLACE_ME",
  "type": "Z01",
  "permissionList": {
    "permissions": [
      {
        "reasonList": {
          "reasons": [
            {
              "code": "Z03"
            }
          ]
        },
        "mktActivityRecordList": {
          "mktActivityRecords": [
            {
              "type": "at-eda"
            }
          ]
        }
      }
    ]
  }
}
```

The MRID should be replaced by the permission ID, the code `Z03` stands for „cancelled by eligible party“ and the
type `Z01` identifies this document as a termination document.
If the kafka message key is unknown, the type of the mktActivityRecord is used, which is identical to the region
connector id.

## Configuring the example app

If you are using the example app and you change configuration parameters for the _core_, you might need to update its
configuration as well.
Please refer to the [readme.md](../examples/example-app/README.md) of the example app.
