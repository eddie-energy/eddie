# EDDIE Framework operation manual

## Quickstart

A quickstart configuration to run the EDDIE Framework is provided in the `.env` folder of the development project. The
steps to make it run are:

1. Download the quickstart configuration folder from [EDDIE /env](https://github.com/eddie-energy/eddie/tree/main/env)
2. Run `docker compose up -d` in that folder.
3. Open browser on http://127.0.0.1:9000/prototype/main/ and experiment with the provided sample application.
4. As many permission administrators and metered data administrators require additional installation or registration
   steps, it's best to try out the framework functionality using the permission administrator called _simulation_.

## Installation

TBD.

A sample container configuration in `docker-compose.yml`:

````yaml
version: "3.9"
services:
  eddie:
    image: ghcr.io/eddie-energy/eddie:latest
    environment:
      JDBC_URL: "jdbc:postgresql://localhost:5432/example_app"
      JDBC_USER: "test"
      JDBC_PASSWORD: "test"
      PUBLIC_CONTEXT_PATH: ""                            # default value
      IMPORT_CONFIG_FILE: "file:./config/data-needs.yml" # default value
    volumes:
      - ./ponton:/ponton
      - ./data-needs.yml:/opt/eddie/config/data-needs.yml
````

| Variable             | Description                                             |
|----------------------|---------------------------------------------------------|
| `IMPORT_CONFIG_FILE` | Comma separated list of Spring configuration locations. |

- `IMPORT_CONFIG_FILE` follows the same syntax and semantics as `spring.config.import`, see
  [Spring Boot Reference](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config.files.optional-prefix)

As the configuration of region connectors is quite complex and there are many properties, the environment is
configured in the accompanying `.env` file (see [EDDIE /env](https://github.com/eddie-energy/eddie/tree/main/env)
directory for a reference).
The example `.env` file contains all configuration options.

## Update

TBD.

## Integration

TBD.

#### Using the EDDIE Button in an application

To use the _EDDIE Button_ in an eligible party application. This EP application has to include the button in its HTML
page. It can be integrated into a frontend based application (e.g. a single-page application) or into a server rendered
web application as it's implemented using standard HTML custom elements.

```html
<script type="module" src="${eddieUrl}/lib/eddie-components.js"></script>
<!-- ... -->
<eddie-connect-button
  connection-id="1"
  data-need-id="LAST_3_MONTHS_ONE_MEASUREMENT_PER_DAY"
></eddie-connect-button>
```

`${eddieUrl}` is to be replaced with the public base URL of your EDDIE instance.

The `eddie-connect-button` element can be configured using the following attributes:

| Attribute      | Type   | Description                                          |
|----------------|--------|------------------------------------------------------|
| `eddieUrl`     | URL    | Public base URL of EDDIE                             |
| `connectionId` | String | Connection id generated by application _using_ EDDIE |
| `dataNeedId`   | String | Id of a pre-configured data-need                     |
| Attribute                       | Type    | Description                                                                                                      |
| ------------------------------- | ------- | ---------------------------------------------------------------------------------------------------------------- |
| `connection-id`                 | String  | The connection id can be generated by application _using_ EDDIE to identify generated requests.                  |
| `data-need-id`                  | String  | ID of a pre-configured data need. Required if `allow-data-need-selection` is not `true`.                         |
| `allow-data-need-modifications` | Boolean | If true, the user can modify data need values. This feature is intended for development purposes only.           |
| `allow-data-need-selection`     | Boolean | If true, the user can select a pre-configured data need. This feature is intended for development purposes only. |
| `permission-administrator`      | String  | Sets a fixed permission administrator to use by its id.                                                          |

The `connectionId` has to be generated by the EP application. It's included in the messages sent by EDDIE
so that button instance can match with the data stream that is created using it. The EP application is also
responsible for storing previous connection IDs and linking them to the users of the EP application. Each connection
id must be used only once to create a uniquely identifiable connection with EDDIE.

## Configuration

Configuration parameters can be modified in the following locations:

- **Environment variables**: They are described in the _Installation_ section of this document.
- `data-needs.yml`: This file contains the data needs configuration. It's intended content is described in the section
  _DataNeed configuration_.
- `application.properties`: A base configuration is provided inside of the application, but additional values are
  required that can be supplied in EDDIE's runtime directory (`./application.properties`). The base
  configuration is located
  at [core/src/main/resources/application.properties](https://github.com/eddie-energy/eddie/blob/main/core/src/main/resources/application.properties).

### Business domain related configuration

#### Common Information Model (CIM)

For the mapping of region specific data to the common information model (CIM) the following configuration parameters
need to be set:

| Parameter                                 | Type                               | Description                                                                         |
|-------------------------------------------|------------------------------------|-------------------------------------------------------------------------------------|
| cim.eligible-party.national-coding-scheme | A valid CodingSchemeTypeList value | Most of the time just 'N' + your country code e.g NAT if you are located in Austria |

E.g. eligible party in Austria:

```
cim.eligible-party.national-coding-scheme=NAT
```

#### Data need configuration

A data need
([class DataNeed in logical data model](https://eddie-web.projekte.fh-hagenberg.at/docs/requirements/4_data_requirements/1_logical_data_model/))
describes a configuration for the _Connect Button_. By using that button, the type of data and time frame is predefined
so that the EP application receives data that it actually needs to perform its job.

Data needs can be configured in two ways: via the spring configuration or they can be set via a REST-ful API which
stores
the data needs in the framework's database.

| Parameter                                | Type              | Description                                           |
|------------------------------------------|-------------------|-------------------------------------------------------|
| eddie.data-needs-config.data-need-source | CONFIG / DATABASE | Specifies the location where data needs are read from |

If this is set to `DATABASE` no data needs are allowed in the configuration.

**Data needs when using database**

When using the database as source for data needs, the data need config file needs to contain *only* the following
config:  
`config/data-needs.yml`

```yaml
eddie:
  data-needs-config:
    data-need-source=DATABASE
```

**Data needs in configuration**

`config/data-needs.yml`

```yaml
eddie:
  data-needs-config:
    data-need-source: CONFIG
    data-needs:
      - id: LAST_3_MONTHS_ONE_MEASUREMENT_PER_DAY
        description: Historical validated consumption data for the last three months, one measurement per day
        type: HISTORICAL_VALIDATED_CONSUMPTION_DATA
        granularity: P1D
        duration-start: -90
        duration-open-end: false
        duration-end: 0
      - id: FUTURE_NEAR_REALTIME_DATA
        description: Near realtime consumption data from the smart meter
        type: AIIDA_NEAR_REALTIME_DATA
        granularity: PT5M
        duration-start: 0
        duration-open-end: false
        duration-end: 10
        transmission-interval: 5
        shared-data-ids:
          - "1-0:1.7.0"
          - "1-0:1.8.0"
        service-name: "My awesome energy service"
```

| Attribute             | Type                        | Description                                                                                                                                   |
|-----------------------|-----------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| id                    | String                      | Unique id that can be used to reference this DataNeed                                                                                         |
| description           | String                      | Multiline string that describes this DataNeed in a human readable form to be shown in the UI                                                  |
| type                  | DataType                    |                                                                                                                                               |
| granularity           | MeteringInterval (optional) | Describing the measurements per 24h only relevant for validated consumption data                                                              |
| duration-start        | Integer (signed)            | Beginning of the metering data in days after the current date                                                                                 |
| duration-end          | Integer (signed, optional)  | End of the metering data in days after the current date                                                                                       |
| duration-open-end     | Boolean (optional)          | If true, the value of `durationEnd` is ignored and the time interval is open ended                                                            |
| transmission-interval | Integer                     | Interval in seconds between two data transmissions from AIIDA to the EP. Only required if the DataType is `AIIDA_NEAR_REALTIME_DATA`          |
| shared-data-ids       | Set of Strings              | Set of Strings that describe the data that should be shared by an AIIDA instance. Only required if the DataType is `AIIDA_NEAR_REALTIME_DATA` |
| service-name          | String                      | Name of the service that this DataNeed was created for. Only required if the DataType is `AIIDA_NEAR_REALTIME_DATA`                           |

- A DataNeed is mandatory for each _Connect with EDDIE_ Button.
- `durationStart` and `durationEnd` are relative to the time when a Connection is actually created by the User on the UI
- If `durationStart` or `durationEnd` are negative, that is interpreted as days _before_ the current date.

**Constraints:**

- If `type` is `HISTORICAL_VALIDATED_CONSUMPTION_DATA`, `durationEnd` has to be zero or negative.
- If `type` is `FUTURE_VALIDATED_CONSUMPTION_DATA`, `durationStart` has to be zero or positive.
- `durationEnd` is mandatory, except if `type` is `ACCOUNTING_POINT_MASTER_DATA`
- `durationStart` has to be smaller than `durationEnd`
- `durationOpenEnd` can only be true if future data is requested

**Enum: DataType**

| Value                                   | Description                                                                                                |
|-----------------------------------------|------------------------------------------------------------------------------------------------------------|
| `HISTORICAL_VALIDATED_CONSUMPTION_DATA` | consumption records will contain historical validated consumption data from  the past                      |
| `FUTURE_VALIDATED_CONSUMPTION_DATA`     | consumption records will contain historical validated consumption data but it's requested for future times |
| `AIIDA_NEAR_REALTIME_DATA`              | consumption records will be unvalidated near-realtime data directly from a P1 meter                        |
| `ACCOUNTING_POINT_MASTER_DATA`          | master data for the accounting point                                                                       |

- A request to `HISTORICAL_VALIDATED_CONSUMPTION_DATA` and `FUTURE_VALIDATED_CONSUMPTION_DATA` leads to the same data
  structure delivered by EDDIE. But the process of requesting these kinds of data differ, so it's
  currently not possible to mix both in a single request.

**Enum: MeteringInterval**

| Value   | Values per 24h | Description      |
|---------|----------------|------------------|
| `P1Y`   | n.a.           | once per year    |
| `P1M`   | n.a.           | once per month   |
| `P1D`   | 1              | once per day     |
| `PT1H`  | 24             | once per hour    |
| `PT30M` | 48             | every 30 minutes |
| `PT15M` | 96             | every 15 minutes |
| `PT10M` | 144            | every 10 minutes |
| `PT5M`  | 288            | every 5 minutes  |

### External system related

#### Kafka Connector

All configuration values that are available for Kafka producers and consumers are supported,
see [kafka: Producer Configs](https://kafka.apache.org/28/documentation.html#producerconfigs). To include them the
prefix `kafka.` has to be used.

The following parameters are of special interest:

| Parameter               | Type                                            | Description                                                                                                       |
|-------------------------|-------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| kafka.bootstrap.servers | comma-separated _host:port_  tuples (mandatory) | A list of host/port pairs to use for establishing the initial connection to the Kafka cluster.                    |
| kafka.enable            | true/false                                      | Enables or disables the kafka connector.                                                                          |
| kafka.termination.topic | valid kafka topic name                          | The topic on which the kafka connector listens for termination requests. Optional, the default is `terminations`. |

E.g. if Kafka is installed locally:

```
kafka.bootstrap.servers=localhost:9093
```

##### Termination of Permission Requests

To terminate permission requests, a consent market document in json format has to be sent to
the `kafka.termination.topic`.
The key should be the ID of the region connector, from which the request originated.
The consent market document can look like this:

```json
{
  "mrid": "REPLACE_ME",
  "permissionList": {
    "permissions": [
      {
        "reasonList": {
          "reasons": [
            {
              "code": "Z03"
            }
          ]
        },
        "mktActivityRecordList": {
          "mktActivityRecords": [
            {
              "type": "at-eda"
            }
          ]
        }
      }
    ]
  }
}
```

The MRID should be replaced by the permission ID, the code `Z03` stands for „cancelled by eligible party“.
If the kafka message key is unknown, the type of the mktActivityRecord is used, which is identical to the region
connector id.
